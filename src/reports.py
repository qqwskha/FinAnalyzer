import pandas as pd
import datetime
import logging
from typing import Optional, Callable
import os

# Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


# ðŸ“ Ð”ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð² Ð² Ñ„Ð°Ð¹Ð»
def save_report(file_name: Optional[str] = None):
    """
    Ð”ÐµÐºÐ¾Ñ€Ð°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð² Ñ„Ð°Ð¹Ð».
    Ð•ÑÐ»Ð¸ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¸Ð¼Ñ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ.
    """

    def decorator(func: Callable):
        def wrapper(*args, **kwargs):
            result = func(*args, **kwargs)
            nonlocal file_name
            if not file_name:
                file_name = f"{func.__name__}_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"

            output_path = os.path.join("../data/reports", file_name)
            os.makedirs(os.path.dirname(output_path), exist_ok=True)

            if isinstance(result, pd.DataFrame):
                result.to_csv(output_path, index=False)
                logger.info(f"ÐžÑ‚Ñ‡ÐµÑ‚ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½ Ð² Ñ„Ð°Ð¹Ð»: {output_path}")
            else:
                logger.error("Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð¾Ð»Ð¶Ð½Ð° Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒ DataFrame Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°.")
            return result

        return wrapper

    return decorator


# ðŸ“Š Ð¢Ñ€Ð°Ñ‚Ñ‹ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
@save_report()
def spending_by_category(transactions: pd.DataFrame, category: str, date: Optional[str] = None) -> pd.DataFrame:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ‚Ñ€Ð°Ñ‚Ñ‹ Ð¿Ð¾ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¹ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3 Ð¼ÐµÑÑÑ†Ð°.
    """
    if date:
        current_date = pd.to_datetime(date)
    else:
        current_date = pd.Timestamp.now()

    start_date = current_date - pd.DateOffset(months=3)

    transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] = pd.to_datetime(transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'])
    filtered_data = transactions[
        (transactions['ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ'] == category) &
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] >= start_date) &
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] <= current_date)
        ]

    report = filtered_data[['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸', 'Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸', 'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ']]
    return report


# ðŸ“… Ð¢Ñ€Ð°Ñ‚Ñ‹ Ð¿Ð¾ Ð´Ð½ÑÐ¼ Ð½ÐµÐ´ÐµÐ»Ð¸
@save_report()
def spending_by_weekday(transactions: pd.DataFrame, date: Optional[str] = None) -> pd.DataFrame:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÑ€ÐµÐ´Ð½Ð¸Ðµ Ñ‚Ñ€Ð°Ñ‚Ñ‹ Ð¿Ð¾ Ð´Ð½ÑÐ¼ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3 Ð¼ÐµÑÑÑ†Ð°.
    """
    if date:
        current_date = pd.to_datetime(date)
    else:
        current_date = pd.Timestamp.now()

    start_date = current_date - pd.DateOffset(months=3)

    transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] = pd.to_datetime(transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'])
    filtered_data = transactions[
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] >= start_date) &
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] <= current_date)
        ]

    filtered_data['Ð”ÐµÐ½ÑŒ Ð½ÐµÐ´ÐµÐ»Ð¸'] = filtered_data['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'].dt.day_name()
    report = (
        filtered_data.groupby('Ð”ÐµÐ½ÑŒ Ð½ÐµÐ´ÐµÐ»Ð¸')['Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸']
        .mean()
        .reset_index()
        .sort_values(by='Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸', ascending=False)
    )
    return report


# ðŸ“† Ð¢Ñ€Ð°Ñ‚Ñ‹ Ð² Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ð¹/Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ð´ÐµÐ½ÑŒ
@save_report()
def spending_by_workday(transactions: pd.DataFrame, date: Optional[str] = None) -> pd.DataFrame:
    """
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÑ€ÐµÐ´Ð½Ð¸Ðµ Ñ‚Ñ€Ð°Ñ‚Ñ‹ Ð² Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ðµ Ð¸ Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð½Ð¸ Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 3 Ð¼ÐµÑÑÑ†Ð°.
    """
    if date:
        current_date = pd.to_datetime(date)
    else:
        current_date = pd.Timestamp.now()

    start_date = current_date - pd.DateOffset(months=3)

    transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] = pd.to_datetime(transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'])
    filtered_data = transactions[
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] >= start_date) &
        (transactions['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'] <= current_date)
        ]

    filtered_data['Ð¢Ð¸Ð¿ Ð´Ð½Ñ'] = filtered_data['Ð”Ð°Ñ‚Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸'].dt.dayofweek.apply(
        lambda x: 'Ð Ð°Ð±Ð¾Ñ‡Ð¸Ð¹ Ð´ÐµÐ½ÑŒ' if x < 5 else 'Ð’Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹ Ð´ÐµÐ½ÑŒ'
    )

    report = (
        filtered_data.groupby('Ð¢Ð¸Ð¿ Ð´Ð½Ñ')['Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸']
        .mean()
        .reset_index()
    )
    return report
